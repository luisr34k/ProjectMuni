{% extends "user/index.html" %}
{% load static %}
{% load widget_tweaks %}
{% block content %}
<form method="post" action="{% url 'crear_denuncia' %}" enctype="multipart/form-data" class="w-100">
  {% csrf_token %}

  {# Errores globales / por campo #}
  {{ form.non_field_errors }}
  {% if form.errors %}
    <div class="alert alert-danger shadow-sm">
      <div class="fw-semibold mb-1">Revisa el formulario:</div>
      <ul class="mb-0">
        {% for field, errors in form.errors.items %}
          <li><strong>{{ field|title }}:</strong> {{ errors|join:", " }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  {# coords ocultos #}
  <input type="hidden" id="id_latitud" name="latitud" value="{{ form.data.latitud|default_if_none:'' }}">
  <input type="hidden" id="id_longitud" name="longitud" value="{{ form.data.longitud|default_if_none:'' }}">

  <div class="row g-4">
    <!-- IZQUIERDA -->
    <div class="col-12 col-xl-6">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex align-items-center justify-content-between">
          <h5 class="mb-0">Datos de la denuncia</h5>
          <small class="text-muted">Completa la información</small>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label" for="{{ form.categoria.id_for_label }}">Categoría</label>
            {{ form.categoria|add_class:"form-select" }}
            {% if form.categoria.errors %}<div class="text-danger small mt-1">{{ form.categoria.errors.0 }}</div>{% endif %}
          </div>

          <div class="mb-3">
            <label class="form-label" for="{{ form.fecha_hecho.id_for_label }}">Fecha</label>
            {{ form.fecha_hecho|add_class:"form-control" }}
            {% if form.fecha_hecho.errors %}<div class="text-danger small mt-1">{{ form.fecha_hecho.errors.0 }}</div>{% endif %}
          </div>

          <div class="mb-3">
            <label class="form-label" for="{{ form.descripcion.id_for_label }}">Descripción</label>
            {{ form.descripcion|add_class:"form-control"|attr:"rows:4" }}
            {% if form.descripcion.errors %}<div class="text-danger small mt-1">{{ form.descripcion.errors.0 }}</div>{% endif %}
          </div>

          <div class="mb-1">
            <label class="form-label" for="{{ form.evidencia.id_for_label }}">Evidencia</label>
            {{ form.evidencia|add_class:"form-control" }}
            {% if form.evidencia.errors %}<div class="text-danger small mt-1">{{ form.evidencia.errors.0 }}</div>{% endif %}
            <div class="form-text">Imágenes o PDF (opcional).</div>
          </div>
        </div>
      </div>
    </div>

    <!-- DERECHA -->
    <div class="col-12 col-xl-6">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex align-items-center justify-content-between">
          <h5 class="mb-0">Ubicación y privacidad</h5>
          <small class="text-muted">Selecciona ubicación en el mapa (opcional)</small>
        </div>
        <div class="card-body">
          <!-- MAPA -->
          <div class="mb-4">
            <div id="mapa-denuncia" style="height:320px;border-radius:.75rem;border:1px solid #e6e6e6;"></div>
            <button type="button" id="btn-geolocalizar" class="btn btn-sm btn-outline-primary mt-2">
              <i class="bi bi-geo-alt me-1"></i> Usar mi ubicación
            </button>
          </div>

          <div class="mb-3">
            <label class="form-label" for="{{ form.direccion.id_for_label }}">Dirección</label>
            {{ form.direccion|add_class:"form-control" }}
            {% if form.direccion.errors %}<div class="text-danger small mt-1">{{ form.direccion.errors.0 }}</div>{% endif %}
          </div>

          <div class="mb-3">
            <label class="form-label" for="{{ form.barrio.id_for_label }}">Barrio</label>
            {{ form.barrio|add_class:"form-select" }}
            {% if form.barrio.errors %}<div class="text-danger small mt-1">{{ form.barrio.errors.0 }}</div>{% endif %}
          </div>

          <div class="form-check">
            {{ form.es_anonima|add_class:"form-check-input" }}
            <label class="form-check-label ms-1" for="{{ form.es_anonima.id_for_label }}">Enviar como anónima</label>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Acciones -->
  <div class="d-flex flex-wrap gap-2 justify-content-end mt-3">
    <button type="submit" class="btn btn-primary px-4">Enviar denuncia</button>
    <a href="{% url 'mis_denuncias' %}" class="btn btn-outline-secondary">Mis denuncias</a>
  </div>
</form>

{# Leaflet y tu script #}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="{% static 'js/denuncias_map.js' %}"></script>

<style>
  /* Asegura que Bootstrap no afecte Leaflet */
  .leaflet-container img { max-width: none !important; }
  .leaflet-container { font: inherit; }
</style>
{% endblock %}