{% extends "base.html" %}
{% load static %}

{% block title %}Mapa público{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
<style>
  #map{width:100%;height:calc(100vh - 220px);min-height:480px;border-radius:.75rem}
  /* Leaflet fix: evita que Bootstrap limite los tiles */
  .leaflet-container img{max-width:none!important}
  .legend{
    background:#fff;padding:.5rem .75rem;border-radius:.5rem;
    box-shadow:0 2px 10px rgba(0,0,0,.08);font-size:12px
  }
  .legend .k{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:.4rem}
  .legend .k.den{background:#ff7a59} /* naranja */
  .legend .k.per{background:#3b82f6} /* azul */
</style>
{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">Mapa de San Luis Jilotepeque</h5>
    <div class="d-flex gap-2">
      <button id="btn-denuncias" class="btn btn-sm btn-outline-primary">Ver denuncias</button>
      <button id="btn-permisos"  class="btn btn-sm btn-outline-secondary">Ver construcciones</button>
    </div>
  </div>
  <div class="card-body p-2">
    <div id="map"></div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
  // Centro/zoom consistentes con tus otros mapas
  const CENTER = [{{ center_lat|default:"14.64551" }}, {{ center_lng|default:"-89.72710" }}];
  const ZOOM   = {{ zoom|default:"15" }};

  const map = L.map('map', { center: CENTER, zoom: ZOOM, zoomControl:true, attributionControl:true });

  // === CARTO Voyager (igual que en denuncias_map.js) ===
  L.tileLayer("https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png", {
    maxZoom: 20,
    attribution: 'Leaflet | &copy; OpenStreetMap, &copy; CARTO'
  }).addTo(map);

  // Capas
  const capaDenuncias = L.layerGroup().addTo(map);
  const capaPermisos  = L.layerGroup().addTo(map);

  // Estilos circleMarker (coherentes con tus POIs)
  const EST_DEN = { radius: 7, color: '#ff7a59', fillColor:'#ff7a59', weight: 1, opacity: .95, fillOpacity: .65 };
  const EST_PER = { radius: 7, color: '#3b82f6', fillColor:'#3b82f6', weight: 1, opacity: .95, fillOpacity: .65 };

  // Mock: 6 denuncias + 4 permisos (coordenadas cerca del centro)
  const denuncias = [
    {id:15,lat:14.6478,lng:-89.7319,cat:'Vandalismo',estado:'en revisión',desc:'Daños en parque central'},
    {id:16,lat:14.6459,lng:-89.7332,cat:'Basura',estado:'en proceso',desc:'Acumulación por el mercado'},
    {id:17,lat:14.6490,lng:-89.7284,cat:'Ruido',estado:'enviada',desc:'Altos decibeles nocturnos'},
    {id:18,lat:14.6447,lng:-89.7276,cat:'Alumbrado',estado:'enviada',desc:'Lámparas sin funcionar'},
    {id:19,lat:14.6486,lng:-89.7350,cat:'Vías',estado:'resuelta',desc:'Bache reparado'},
    {id:20,lat:14.6462,lng:-89.7291,cat:'Agua',estado:'en proceso',desc:'Fuga reportada'}
  ];
  const permisos = [
    {id:101,lat:14.6501,lng:-89.7310,tipo:'Permiso de construcción',estado:'en proceso',barrio:'El Centro'},
    {id:102,lat:14.6470,lng:-89.7362,tipo:'Remodelación',estado:'revisada',barrio:'Barrio Los Izotes'},
    {id:103,lat:14.6439,lng:-89.7320,tipo:'Ampliación vivienda',estado:'aceptada',barrio:'El Calvario'},
    {id:104,lat:14.6453,lng:-89.7269,tipo:'Obra menor',estado:'en proceso',barrio:'Barrio Norte'}
  ];

  // Render
  const bounds = [];
  denuncias.forEach(d => {
    L.circleMarker([d.lat, d.lng], EST_DEN)
      .bindPopup(`<b>Denuncia #${d.id}</b><br>${d.cat} · <i>${d.estado}</i><br><small>${d.desc}</small>`)
      .addTo(capaDenuncias);
    bounds.push([d.lat, d.lng]);
  });
  permisos.forEach(p => {
    L.circleMarker([p.lat, p.lng], EST_PER)
      .bindPopup(`<b>${p.tipo} · #${p.id}</b><br>Estado: <i>${p.estado}</i><br><small>Barrio: ${p.barrio}</small>`)
      .addTo(capaPermisos);
    bounds.push([p.lat, p.lng]);
  });

  if (bounds.length) map.fitBounds(bounds, { padding:[18,18] });

  // Control de capas + leyenda
  L.control.layers(null, { "Denuncias": capaDenuncias, "Construcciones": capaPermisos }, { collapsed:true }).addTo(map);

  const legend = L.control({position:'bottomleft'});
  legend.onAdd = () => {
    const div = L.DomUtil.create('div','legend');
    div.innerHTML = `
      <div><span class="k den"></span> Denuncias</div>
      <div><span class="k per"></span> Construcciones</div>
    `;
    return div;
  };
  legend.addTo(map);

  // Botones mostrar/ocultar (demo)
  const btnDen = document.getElementById('btn-denuncias');
  const btnPer = document.getElementById('btn-permisos');
  let showDen = true, showPer = true;

  function toggle(btn, group, onText, offText, onClass, offClass){
    const visible = map.hasLayer(group);
    if (visible){ map.removeLayer(group); btn.classList.remove(onClass); btn.classList.add(offClass); btn.textContent = offText; }
    else{ group.addTo(map); btn.classList.add(onClass); btn.classList.remove(offClass); btn.textContent = onText; }
  }
  btnDen.addEventListener('click', () => toggle(btnDen, capaDenuncias, 'Ocultar denuncias','Ver denuncias','btn-primary','btn-outline-primary'));
  btnPer.addEventListener('click', () => toggle(btnPer, capaPermisos,  'Ocultar construcciones','Ver construcciones','btn-secondary','btn-outline-secondary'));

  // Estado inicial visual
  btnDen.classList.replace('btn-outline-primary','btn-primary'); btnDen.textContent='Ocultar denuncias';
  btnPer.classList.replace('btn-outline-secondary','btn-secondary'); btnPer.textContent='Ocultar construcciones';
</script>
{% endblock %}
