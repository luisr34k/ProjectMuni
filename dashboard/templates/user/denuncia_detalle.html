{% extends "user/index.html" %}
{% load static %}

{% block content %}



<div class="row g-4">
  <!-- Columna izquierda: Información -->
  <div class="col-12 col-xl-7">
    <div class="card">
      <div class="card-header">
        
        <div class="d-flex align-items-center mb-4">
        <div>
          <h4 class="mb-1">Denuncia #{{ d.id }}</h4>
          <div class="text-muted small">
            Creada: {{ d.creada_en|date:"d/m/Y H:i" }}
            {% if d.fecha_hecho %} · Hecho: {{ d.fecha_hecho|date:"d/m/Y" }}{% endif %}
          </div>
        </div>
      </div>
      </div>
      <div class="card-body">
        <dl class="row mb-0">
          <dt class="col-sm-4 col-lg-3">Categoría</dt>
          <dd class="col-sm-8 col-lg-9">{{ d.categoria.nombre }}</dd>

          <!-- Estado debajo de Categoría -->
          <dt class="col-sm-4 col-lg-3">Estado</dt>
          <dd class="col-sm-8 col-lg-9">
            <span class="badge 
              {% if d.estado == 'resuelta' %}bg-label-success
              {% elif d.estado == 'en proceso' %}bg-label-warning
              {% elif d.estado == 'en revisión' %}bg-label-info
              {% elif d.estado == 'rechazada' %}bg-label-danger
              {% else %}bg-label-secondary{% endif %}">
              {{ d.get_estado_display }}
            </span>
          </dd>
          
          <dt class="col-sm-4 col-lg-3">Descripción</dt>
          <dd class="col-sm-8 col-lg-9">{{ d.descripcion|linebreaksbr }}</dd>

          {% if d.ubicacion and d.ubicacion.latitud and d.ubicacion.longitud %}
            <dt class="col-sm-4 col-lg-3">Coordenadas</dt>
            <dd class="col-sm-8 col-lg-9">{{ d.ubicacion.latitud }}, {{ d.ubicacion.longitud }}</dd>
          {% endif %}

          {% if d.evidencia %}
            <dt class="col-sm-4 col-lg-3">Evidencia</dt>
            <dd class="col-sm-8 col-lg-9">
              <a class="btn btn-sm btn-outline-secondary" target="_blank" rel="noopener" href="{{ d.evidencia.url }}">
                <i class="bx bx-file-blank me-1"></i> Ver archivo
              </a>
            </dd>
          {% endif %}
        </dl>
      </div>
    </div>

    {% if d.estado == "rechazada" and d.rechazo_motivo %}
      <div class="alert alert-danger mt-3" role="alert">
        <strong>Rechazada:</strong> {{ d.rechazo_motivo }}
      </div>
    {% endif %}
    
    {% if d.resolucion_nota or d.resolucion_evidencia %}
      <div class="card mt-3">
        <div class="card-header d-flex align-items-center">
          <i class="bx bx-check-circle me-2"></i>
          <h5 class="mb-0">Resolución</h5>
        </div>
        <div class="card-body">
          {% if d.resolucion_nota %}
            <div class="mb-3">{{ d.resolucion_nota|linebreaksbr }}</div>
          {% endif %}
          {% if d.resolucion_evidencia %}
            <a class="btn btn-sm btn-outline-secondary" target="_blank" rel="noopener" href="{{ d.resolucion_evidencia.url }}">
              <i class="bx bx-file me-1"></i> Ver evidencia de resolución
            </a>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Columna derecha: Mapa -->
  <div class="col-12 col-xl-5">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Ubicación</h5>
          <dd class="col-sm-8 col-lg-9">
            {% if d.ubicacion and d.ubicacion.direccion %}
              {{ d.ubicacion.direccion }}
            {% else %}
              <span class="text-muted">Sin dirección</span>
            {% endif %}
            {% if d.ubicacion and d.ubicacion.barrio %}
              <div class="text-muted small">Barrio: {{ d.ubicacion.barrio.nombre }}</div>
            {% endif %}
          </dd>
      </div>
      <div class="card-body">
        {% if d.ubicacion and d.ubicacion.latitud and d.ubicacion.longitud %}
          <div id="mapa-detalle" style="height:320px;border:1px solid #e9ecef;border-radius:.5rem;"></div>
        {% else %}
          <p class="text-muted mb-0">No hay coordenadas para mostrar en el mapa.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{# === HISTORIAL (Bitácora) === #}
<div class="card mt-3">
  <div class="card-header d-flex align-items-center justify-content-between">
    <h6 class="mb-0">Bitácora</h6>
    <small class="text-muted">Cambios y eventos</small>
  </div>
  <div class="card-body">
    {% if bitacoras %}
      <ul class="list-unstyled mb-0">
        {% for b in bitacoras %}
          <li class="mb-3 pb-3 border-bottom">
            <div class="d-flex justify-content-between">
              <strong>{{ b.accion }}</strong>
              <small class="text-muted">{{ b.fecha|date:"d/m/Y H:i" }}</small>
            </div>

            {% if b.estado_anterior or b.estado_nuevo %}
              <div class="small text-muted">
                Estado: {{ b.estado_anterior|default:"—" }} → {{ b.estado_nuevo|default:"—" }}
              </div>
            {% endif %}

            {% if b.cambios %}
              <details class="mt-1">
                <summary class="small text-muted">Ver cambios</summary>
                {% with elid='cambios_'|add:b.id %}
                  {{ b.cambios|json_script:elid }}
                  <pre class="small mb-0" id="{{ elid }}_pretty"></pre>
                  <script>
                    (function(){
                      var data = JSON.parse(document.getElementById('{{ elid }}').textContent);
                      document.getElementById('{{ elid }}_pretty').textContent = JSON.stringify(data, null, 2);
                    })();
                  </script>
                {% endwith %}
              </details>
            {% endif %}

            {% if b.usuario %}
              <div class="small text-muted">Por: {{ b.usuario.correo }}</div>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="text-muted">Aún no hay eventos.</div>
    {% endif %}
  </div>
</div>

{% if d.ubicacion and d.ubicacion.latitud and d.ubicacion.longitud %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    (function() {
      var lat = {{ d.ubicacion.latitud|floatformat:6 }};
      var lng = {{ d.ubicacion.longitud|floatformat:6 }};
      var map = L.map('mapa-detalle', { zoomControl: true }).setView([lat, lng], 16);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        maxZoom: 20,
        attribution: '&copy; OpenStreetMap, &copy; CARTO'
      }).addTo(map);
      L.marker([lat, lng]).addTo(map);
    })();
  </script>
  <style>.leaflet-container img{max-width:none!important}</style>
{% endif %}

{% endblock %}
