{% extends "admin_panel/base_admin.html" %}
{% load widget_tweaks %}

{% block admin_title %}Permiso #{{ p.id }}{% endblock %}

{% block content %}
<div class="row g-4">
  <!-- Detalle -->
  <div class="col-12 col-lg-8">
    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-3">
          <a class="btn btn-sm btn-outline-secondary" href="{% url 'admin_permisos' %}">← Volver</a>
          <h5 class="mb-0">
            Permiso #{{ p.id }}{% if p.tipo_permiso %} — {{ p.tipo_permiso.nombre }}{% endif %}
          </h5>
        </div>
        <div>
          {% if p.estado == "enviada" %}
            <span class="badge rounded-pill bg-secondary-subtle text-secondary border">Enviada</span>
          {% elif p.estado == "revisada" %}
            <span class="badge rounded-pill bg-info-subtle text-info border">Revisada</span>
          {% elif p.estado == "aceptada" %}
            <span class="badge rounded-pill bg-primary-subtle text-primary border">Aceptada</span>
          {% elif p.estado == "en proceso" %}
            <span class="badge rounded-pill bg-warning-subtle text-warning border">En proceso</span>
          {% elif p.estado == "finalizada" %}
            <span class="badge rounded-pill bg-success-subtle text-success border">Finalizada</span>
          {% else %}
            <span class="badge rounded-pill bg-secondary-subtle text-secondary border">{{ p.estado }}</span>
          {% endif %}
        </div>
      </div>

      <div class="card-body">
        <!-- Meta -->
        <div class="row gy-3">
          <div class="col-12 col-md-6">
            <div class="small text-muted">Usuario</div>
            <div class="fw-semibold">
              {% if p.usuario %}{{ p.usuario.correo }}{% else %}<span class="text-muted">—</span>{% endif %}
            </div>
          </div>
          <div class="col-12 col-md-6">
            <div class="small text-muted">Creado</div>
            <div class="fw-semibold">{{ p.creado_en|date:"d/m/Y H:i" }}</div>
          </div>
          <div class="col-12 col-md-6">
            <div class="small text-muted">Periodo</div>
            <div class="fw-semibold">
              {{ p.comienza_en|date:"d/m/Y H:i" }} — {{ p.termina_en|date:"d/m/Y H:i" }}
            </div>
          </div>
          {% if p.finalizado_en %}
          <div class="col-12 col-md-6">
            <div class="small text-muted">Finalizado</div>
            <div class="fw-semibold">{{ p.finalizado_en|date:"d/m/Y H:i" }}</div>
          </div>
          {% endif %}
        </div>

        <hr class="my-4">

        <!-- Descripción -->
        <div class="mb-4">
          <div class="small text-muted mb-1">Descripción</div>
          <div class="p-3 rounded-3 bg-light">{{ p.descripcion|default:"—"|linebreaksbr }}</div>
        </div>

        <!-- Requerimientos -->
        <div class="mb-4 d-flex flex-wrap gap-2">
          <span class="badge rounded-pill {% if p.requiere_pmt %}bg-primary-subtle text-primary border{% else %}bg-secondary-subtle text-secondary border{% endif %}">
            PMT: {% if p.requiere_pmt %}Sí{% else %}No{% endif %}
          </span>
          <span class="badge rounded-pill {% if p.requiere_conos %}bg-primary-subtle text-primary border{% else %}bg-secondary-subtle text-secondary border{% endif %}">
            Conos: {% if p.requiere_conos %}Sí{% else %}No{% endif %}
          </span>
        </div>

        <!-- Ubicación -->
        {% if p.ubicacion %}
          <div class="row gy-3 mb-4">
            <div class="col-12 col-md-8">
              <div class="small text-muted">Dirección</div>
              <div class="fw-semibold">{{ p.ubicacion.direccion|default:"—" }}</div>
              {% if p.ubicacion.barrio %}
                <div class="small text-muted mt-2">Barrio</div>
                <div class="fw-semibold">{{ p.ubicacion.barrio.nombre }}</div>
              {% endif %}
            </div>
            {% if p.ubicacion.latitud and p.ubicacion.longitud %}
              <div class="col-12 col-md-4">
                <div class="small text-muted">Coordenadas</div>
                <div class="fw-semibold">{{ p.ubicacion.latitud }}, {{ p.ubicacion.longitud }}</div>
                <a class="btn btn-sm btn-outline-primary mt-2"
                   target="_blank"
                   href="https://www.google.com/maps?q={{ p.ubicacion.latitud }},{{ p.ubicacion.longitud }}">
                  Ver en mapa
                </a>
              </div>
            {% endif %}
          </div>
        {% endif %}

        <!-- Adjuntos -->
        <div class="mb-2">
          <div class="small text-muted mb-2">Adjuntos</div>
          <div class="d-flex flex-wrap gap-2">
            <div>
              <span class="small text-muted d-block">DPI (frente)</span>
              {% if p.dpi_frente %}
                <a class="btn btn-sm btn-outline-secondary" target="_blank" href="{{ p.dpi_frente.url }}">Ver / descargar</a>
              {% else %}<span class="text-muted small">No adjunto</span>{% endif %}
            </div>
            <div>
              <span class="small text-muted d-block">DPI (reverso)</span>
              {% if p.dpi_reverso %}
                <a class="btn btn-sm btn-outline-secondary" target="_blank" href="{{ p.dpi_reverso.url }}">Ver / descargar</a>
              {% else %}<span class="text-muted small">No adjunto</span>{% endif %}
            </div>
            <div>
              <span class="small text-muted d-block">Evidencia del lugar</span>
              {% if p.evidencia_lugar %}
                <a class="btn btn-sm btn-outline-secondary" target="_blank" href="{{ p.evidencia_lugar.url }}">Ver / descargar</a>
              {% else %}<span class="text-muted small">No adjunto</span>{% endif %}
            </div>
          </div>
        </div>

        {% if p.estado == "aceptada" %}
          <hr class="my-4">
          <div class="mb-2">
            <div class="small text-muted mb-1">Aceptación</div>
            {% if p.aceptacion_nota %}
              <div class="mb-2 p-3 rounded-3 bg-light">{{ p.aceptacion_nota|linebreaksbr }}</div>
            {% endif %}
            {% if p.permiso_adjunto %}
              <a class="btn btn-sm btn-outline-secondary" target="_blank" href="{{ p.permiso_adjunto.url }}">
                Ver permiso adjunto
              </a>
            {% elif not p.aceptacion_nota %}
              <span class="text-muted">Sin nota ni adjunto.</span>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Cambiar estado -->
  <div class="col-12 col-lg-4">
    <div class="card shadow-sm position-sticky" style="top: 1rem;">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Cambiar estado</h5>
        <span class="badge bg-secondary-subtle text-secondary border">{{ p.estado|title }}</span>
      </div>
      <div class="card-body">
        <form method="post" action="{% url 'admin_permiso_cambiar_estado' p.id %}" enctype="multipart/form-data">
          {% csrf_token %}

          <div class="mb-3">
            <label class="form-label" for="estado-admin">Estado</label>
            {% render_field form_estado.estado class="form-select" id="estado-admin" %}
          </div>

          {# visible solo si el select == 'aceptada' #}
          <div id="bloque-aceptada" style="display:none;">
            <div class="mb-3">
              <label class="form-label" for="nota-aceptacion-admin">Nota de aceptación</label>
              {% render_field form_estado.aceptacion_nota class="form-control" id="nota-aceptacion-admin" %}
            </div>
            <div class="mb-3">
              <label class="form-label" for="adjunto-permiso-admin">Permiso adjunto (opcional)</label>
              {% render_field form_estado.permiso_adjunto class="form-control" id="adjunto-permiso-admin" %}
              {% if p.permiso_adjunto %}
                <div class="mt-2">
                  <a class="btn btn-sm btn-outline-secondary" target="_blank" href="{{ p.permiso_adjunto.url }}">Ver adjunto actual</a>
                </div>
              {% endif %}
            </div>
            <div class="mb-3">
              <label class="form-label" for="{{ form_estado.observaciones.id_for_label }}">Observaciones (visibles al usuario)</label>
              {{ form_estado.observaciones|add_class:"form-control" }}
            </div>
          </div>

          <button class="btn btn-primary w-100">Guardar</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Bitácora -->
<div class="card mt-4 shadow-sm">
  <div class="card-header d-flex align-items-center justify-content-between">
    <h6 class="mb-0">Bitácora</h6>
    <small class="text-muted">Cambios y eventos</small>
  </div>
  <div class="card-body">
    {% if bitacoras %}
      <ul class="list-unstyled mb-0">
        {% for b in bitacoras %}
          <li class="mb-3 pb-3 border-bottom">
            <div class="d-flex justify-content-between">
              <strong>{{ b.accion }}</strong>
              <small class="text-muted">{{ b.fecha|date:"d/m/Y H:i" }}</small>
            </div>
            {% if b.estado_anterior or b.estado_nuevo %}
              <div class="small text-muted">Estado: {{ b.estado_anterior|default:"—" }} → {{ b.estado_nuevo|default:"—" }}</div>
            {% endif %}
            {% if b.cambios is not None %}
              {% with elid='cambios_'|add:b.id|stringformat:"s" %}
                {{ b.cambios|json_script:elid }}
                <details class="mt-1">
                  <summary class="small text-muted">Ver cambios</summary>
                  <pre class="small mb-0 pretty-json" data-source="{{ elid }}"></pre>
                </details>
              {% endwith %}
            {% endif %}
            {% if b.usuario %}
              <div class="small text-muted">Por: {{ b.usuario.correo }}</div>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="text-muted">Aún no hay eventos.</div>
    {% endif %}
  </div>
</div>

{# Script de toggles (reutiliza tu lógica; ahora con IDs consistentes) #}
<script>
  (function(){
    var sel  = document.querySelector('select[name="{{ form_estado.estado.html_name }}"]') || document.getElementById('estado-admin');
    var box  = document.getElementById('bloque-aceptada');
    var nota = document.getElementById('nota-aceptacion-admin');
    var adj  = document.getElementById('adjunto-permiso-admin');
    if (!sel || !box) return;

    function isAceptada(v){
      return (v || '').trim().toLowerCase() === 'aceptada';
    }
    function toggle(){
      var v = sel.value;
      var on = isAceptada(v);
      box.style.display = on ? 'block' : 'none';
      if (nota) nota.disabled = !on;
      if (adj)  adj.disabled  = !on;
    }
    sel.addEventListener('change', toggle);
    toggle();
  })();
</script>
{% endblock %}

