{% extends "base.html" %}
{% load static %}

{% block title %}Pago #{{ pago.id }}{% endblock %}

{% block content %}
<div class="container-xxl container-p-y">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-bold mb-0">Pago #{{ pago.id }}</h4>
    <div class="d-flex gap-2">
      <a href="{% url 'admin_pagos' %}" class="btn btn-outline-secondary">Volver</a>
      <a href="{% url 'admin_pago_reenviar_recibo' pago.id %}" class="btn btn-outline-primary">Reenviar recibo</a>
      <a href="{% url 'recibo_pago' pago.id %}" class="btn btn-primary">Ver recibo</a>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-header"><strong>Resumen</strong></div>
        <div class="card-body">
          <dl class="row mb-0">
            <dt class="col-sm-4">Fecha</dt><dd class="col-sm-8">{{ pago.creado_en|default:pago.fecha }}</dd>
            <dt class="col-sm-4">Titular</dt><dd class="col-sm-8">{{ pago.cuenta.titular }}</dd>
            <dt class="col-sm-4">Cuenta</dt><dd class="col-sm-8">{{ pago.cuenta.codigo_catastral|default:pago.cuenta.id }}</dd>
            <dt class="col-sm-4">Método</dt><dd class="col-sm-8">{{ pago.metodo }}</dd>
            <dt class="col-sm-4">Referencia</dt><dd class="col-sm-8">{{ pago.referencia }}</dd>
            <dt class="col-sm-4">Monto</dt><dd class="col-sm-8">Q {{ pago.monto }}</dd>
          </dl>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-header"><strong>Transacciones</strong></div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm mb-0">
              <thead>
                <tr><th>Fecha</th><th>Estado</th><th>Orden</th></tr>
              </thead>
              <tbody>
                {% for t in trans %}
                <tr>
                  <td>{{ t.actualizado_en|default:t.creado_en }}</td>
                  <td>
                    <span class="badge
                    {% if t.estado == 'success' %}bg-success
                    {% elif t.estado == 'failed' %}bg-danger
                    {% else %}bg-secondary
                    {% endif %}">
                    {{ t.estado }}
                  </span>
                  </td>
                  <td>{{ t.orden_id }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="3" class="text-center text-muted py-3">Sin transacciones</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="p-2 text-muted small border-top">
            El payload completo queda en DB (campo <em>payload</em> en <code>TransaccionOnline</code>).
          </div>
        </div>
      </div>
    </div>

    {% if aplicaciones %}
    <div class="col-12">
      <div class="card">
        <div class="card-header"><strong>Aplicaciones en boletas</strong></div>
        <div class="table-responsive">
          <table class="table table-sm mb-0">
            <thead>
              <tr><th>Período</th><th>Monto aplicado (Q)</th></tr>
            </thead>
            <tbody>
              {% for a in aplicaciones %}
              <tr>
                <td>{{ a.boleta.periodo.anio }}-{{ a.boleta.periodo.mes }}</td>
                <td>{{ a.monto_aplicado }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
